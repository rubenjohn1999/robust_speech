# Instructions to experiment with Diffwave

Installations

```
git clone https://github.com/rubenjohn1999/robust_speech.git
git checkout ddpm-diffwave

# Install the requirements for the Diffwave DDPM mdoel
cd robust_speech/robust_speech/adversarial/defenses/diffwave
pip install .

# Install the requirements for the robust_speech framework
cd robust_speech
pip install .

```

NOTE: The code the Diffwave model has been taken from their [repository](https://github.com/lmnt-com/diffwave)

- Be sure to go through the README.md file to setup the robust_speech repository and download the Librispeech corpus into path/to/results/folder/data
- The file robust_speech/robust_speech/adversarial/defenses/ddpm.py acts as the entrypoint to the DDPM
- The model file robust_speech/robust_speech/models/wav2vec2_fine_tune.py has been modified to add a check for DDPM and subsequently the robust_speech/recipes/model_configs/wav2vec2-large-960h.yaml has been modified to include the reference to the DDPM
- The Diffwave code has been added at robust_speech/robust_speech/adversarial/defenses/diffwave folders.
- The pretrained checkpoint to Diffwave should be present at robust_speech/recipes/ddpm_model
- Follow the usual robust_speech instructions to train wav2vec2-large-960h and run 
```
python evaluate.py attack_configs/LibriSpeech/none/w2v2_large_960h.yaml --root=/path/to/results/folder
```

Training DDPM requires wav files that can be generated by running the script to convert FLAC to WAV foles
```
# in robust_speech/robust_speech/adversarial/defenses/diffwave
mkdir wav
sudo apt install ffmpeg
bash convert_flac_to_wav.sh  # be sure to read through the file to mention the folder where the FLAC files are present
```

Additional details about training the Diffwave model can be found in robust_speech/adversarial/defenses/diffwave/README.md


## How to use the DDPM to run attacks
Here is a set of instructions on how to use DDPM while running experiments for CW attack.

### Configuration 1: Smoothing --> DDPM 

If we only want the DDPM to be present, your wav2vec2-large-960h.yaml (```robust_speech/recipes/model_configs/wav2vec2-large-960h.yaml```) file should look like the one below.

Example: Say we want to run CW for sigma=0.02 for the configuration of only DDPM


The wav2vec2-large-960h.yaml block will look like this
```
sigma: 0.02
# smoothing: !new:robust_speech.adversarial.defenses.smoothing.SpeechNoiseAugmentation
#    sigma: !ref <sigma>
   # filter config
   # filter: !name:robust_speech.adversarial.defenses.filter.ASNRWiener
   #    sr: 16000
   #    hop: 160
   #    nfft: 1024
   # enhancer: null

ddpm: !new:robust_speech.adversarial.defenses.ddpm.DDPM
    sigma: !ref <sigma>
    # change this path based on directory structure
    model_dir: /home/ubuntu/robust_speech/recipes/ddpm_model/unconditional-weights-691998.pt
    sr: 16000
   #  filter: !name:robust_speech.adversarial.defenses.filter.ASNRWiener
   #    sr: 16000
   #    hop: 160
   #    nfft: 1024
   ```

### Configuration 2: Smoothing --> DDPM --> wiener

If we want both DDPM and wiener to be there, then we need to uncomment the wiener filter block that is present near the DDPM in the yaml file

```
sigma: 0.02
# smoothing: !new:robust_speech.adversarial.defenses.smoothing.SpeechNoiseAugmentation
#    sigma: !ref <sigma>
   # filter config
   # filter: !name:robust_speech.adversarial.defenses.filter.ASNRWiener
   #    sr: 16000
   #    hop: 160
   #    nfft: 1024
   # enhancer: null

ddpm: !new:robust_speech.adversarial.defenses.ddpm.DDPM
    sigma: !ref <sigma>
    # change this path based on directory structure
    model_dir: /home/ubuntu/robust_speech/recipes/ddpm_model/unconditional-weights-691998.pt
    sr: 16000
    filter: !name:robust_speech.adversarial.defenses.filter.ASNRWiener
      sr: 16000
      hop: 160
      nfft: 1024
```


Once you have made the changes, install the Diffwave code

```
cd robust_speech/robust_speech/adversarial/defenses/diffwave
pip install .
``` 
Now go ahead and run the evaluate.py file as you would normally. 

NOTE : In both these configurations, the smoothing block is commented except for the line ```sigma: 0.02```, double check this before you go ahead and run. This is because we do smoothing in the DDPM itself.

Also ensure the path to the checkpoint file is correct in the yaml file!
